{% extends "base.html" %}
{% block title %}System{% endblock %}
{% block content %}
<h1>System Health</h1>

<h2>Component Health</h2>
<table class="component-matrix">
    <thead>
        <tr>
            <th>Component</th>
            <th>Status</th>
            <th>Details</th>
        </tr>
    </thead>
    <tbody>
        {% for comp in components %}
        <tr>
            <td>{{ comp.name }}</td>
            <td class="status-cell status-{{ comp.status }}">{{ comp.status | upper }}</td>
            <td>{{ comp.details }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Circuit Breakers</h2>
<div class="card-row">
    {% for cb in circuit_breakers %}
    <div class="breaker-card">
        <h3>{{ cb.name | replace("_", " ") | title }}</h3>
        <div class="breaker-state status-{{ cb.color }}">{{ cb.state }}</div>
        <div class="breaker-threshold">Threshold: {{ cb.threshold }}</div>
    </div>
    {% endfor %}
</div>

{% if reconciliation %}
<h2>Reconciliation Metrics</h2>
<div class="card">
    <table>
        <thead>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Fills Analyzed</td><td>{{ reconciliation.n_fills }}</td></tr>
            <tr><td>Mean Predicted Slippage</td><td>{{ "%.4f"|format(reconciliation.mean_predicted) }}</td></tr>
            <tr><td>Mean Actual Slippage</td><td>{{ "%.4f"|format(reconciliation.mean_actual) }}</td></tr>
            <tr><td>Bias</td><td>{{ "%.4f"|format(reconciliation.bias) }}</td></tr>
            <tr><td>RMSE</td><td>{{ "%.4f"|format(reconciliation.rmse) }}</td></tr>
            <tr><td>Correlation</td><td>{{ "%.4f"|format(reconciliation.correlation) }}</td></tr>
            <tr><td>Pessimism Multiplier</td><td>{{ "%.2f"|format(reconciliation.pessimism_multiplier) }}</td></tr>
            <tr><td>95th Pctl Predicted</td><td>{{ "%.4f"|format(reconciliation.percentile_95_predicted) }}</td></tr>
            <tr><td>95th Pctl Actual</td><td>{{ "%.4f"|format(reconciliation.percentile_95_actual) }}</td></tr>
        </tbody>
    </table>
</div>
{% endif %}

<h2>Runtime Configuration</h2>
<div class="card">
    <ul class="config-list">
        <li><span class="config-key">Data Directory</span><span class="config-value">{{ data_dir }}</span></li>
        <li><span class="config-key">Trading Mode</span><span class="config-value">Paper</span></li>
        <li><span class="config-key">Dashboard Mode</span><span class="config-value">Read-only monitoring</span></li>
        <li><span class="config-key">Agent State</span><span class="config-value status-{{ 'ok' if agent_state == 'running' else 'warn' }}">{{ agent_state | upper }}</span></li>
    </ul>
</div>

<h2>Disk Usage</h2>
<div class="card">
    <table>
        <thead>
            <tr>
                <th>Database</th>
                <th>File</th>
                <th>Size</th>
            </tr>
        </thead>
        <tbody>
            {% for d in disk_usage %}
            <tr>
                <td>{{ d.name }}</td>
                <td><code>{{ d.file }}</code></td>
                <td>{{ d.size }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
