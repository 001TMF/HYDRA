{% extends "base.html" %}
{% block title %}Fills{% endblock %}
{% block content %}
<h1>Fill Journal ({{ fill_count }} fills)</h1>

{% if reconciliation %}
<div class="card">
    <h3>Reconciliation Summary</h3>
    <div class="card-row">
        <div class="stat">
            <span class="label">Bias</span>
            <span class="metric-sm">{{ "%.4f"|format(reconciliation.bias) }}</span>
        </div>
        <div class="stat">
            <span class="label">RMSE</span>
            <span class="metric-sm">{{ "%.4f"|format(reconciliation.rmse) }}</span>
        </div>
        <div class="stat">
            <span class="label">Correlation</span>
            <span class="metric-sm">{{ "%.4f"|format(reconciliation.correlation) }}</span>
        </div>
        <div class="stat">
            <span class="label">Pessimism Multiplier</span>
            <span class="metric-sm">{{ "%.2f"|format(reconciliation.pessimism_multiplier) }}</span>
        </div>
    </div>
</div>
{% endif %}

{% if slippage_data %}
<div class="chart-container">
    <h3>Slippage: Predicted vs Actual</h3>
    <canvas id="slippageScatter"></canvas>
</div>
<script>
(function() {
    const data = {{ slippage_data | tojson }};
    const maxVal = Math.max(...data.map(d => Math.max(d[0], d[1])), 0.1);
    new Chart(document.getElementById('slippageScatter'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Fills',
                data: data.map(d => ({x: d[0], y: d[1]})),
                backgroundColor: 'rgba(78, 204, 163, 0.6)',
                pointRadius: 5,
            }, {
                label: '45-degree line',
                data: [{x: 0, y: 0}, {x: maxVal, y: maxVal}],
                type: 'line',
                borderColor: 'rgba(233, 69, 96, 0.5)',
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#a0a0b8' } } },
            scales: {
                x: { title: { display: true, text: 'Predicted Slippage', color: '#a0a0b8' }, ticks: { color: '#808098' }, grid: { color: '#0f3460' } },
                y: { title: { display: true, text: 'Actual Slippage', color: '#a0a0b8' }, ticks: { color: '#808098' }, grid: { color: '#0f3460' } }
            }
        }
    });
})();
</script>
{% endif %}

<div id="fills-table" hx-get="/fills" hx-trigger="every 60s" hx-select="#fills-table" hx-target="#fills-table" hx-swap="outerHTML">
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Symbol</th>
            <th>Dir</th>
            <th>Contracts</th>
            <th>Order Price</th>
            <th>Fill Price</th>
            <th>Predicted Slip</th>
            <th>Actual Slip</th>
            <th>Latency(ms)</th>
        </tr>
    </thead>
    <tbody>
        {% if fills %}
        {% for fill in fills %}
        <tr>
            <td>{{ fill.timestamp[:19] }}</td>
            <td>{{ fill.symbol }}</td>
            <td class="{% if fill.direction == 1 %}status-ok{% else %}status-alert{% endif %}">
                {% if fill.direction == 1 %}BUY{% else %}SELL{% endif %}
            </td>
            <td>{{ fill.n_contracts }}</td>
            <td>{{ "%.4f"|format(fill.order_price) }}</td>
            <td>{{ "%.4f"|format(fill.fill_price) }}</td>
            <td>{{ "%.4f"|format(fill.predicted_slippage) }}</td>
            <td>{{ "%.4f"|format(fill.actual_slippage) }}</td>
            <td>{{ "%.1f"|format(fill.fill_latency_ms) }}</td>
        </tr>
        {% endfor %}
        {% else %}
        <tr><td colspan="9">No fills recorded yet</td></tr>
        {% endif %}
    </tbody>
</table>
</div>
{% endblock %}
