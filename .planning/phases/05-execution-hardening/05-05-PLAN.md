---
phase: 05-execution-hardening
plan: 05
type: execute
wave: 4
depends_on:
  - 05-04
files_modified:
  - src/hydra/execution/runner.py
  - tests/test_integration_execution.py
  - .planning/phases/05-execution-hardening/PAPER_TRADING_PLAN.md
autonomous: false
requirements:
  - EXEC-01
  - EXEC-05

user_setup:
  - service: Interactive Brokers
    why: "Paper trading requires IB account with paper trading enabled"
    env_vars:
      - name: IB_GATEWAY_HOST
        source: "Usually 127.0.0.1 (localhost) if IB Gateway running locally"
      - name: IB_GATEWAY_PORT
        source: "4002 for IB Gateway paper, 7497 for TWS paper"
    dashboard_config:
      - task: "Install IB Gateway or TWS"
        location: "https://www.interactivebrokers.com/en/trading/ibgateway-stable.php"
      - task: "Enable paper trading account"
        location: "IB Account Management -> Settings -> Paper Trading Account"
      - task: "Install IBC for headless operation (optional)"
        location: "https://github.com/IbcAlpha/IBC/releases"
      - task: "Configure IB Gateway API Settings: enable Socket API, set port 4002, allow localhost"
        location: "IB Gateway -> Configure -> API -> Settings"

must_haves:
  truths:
    - "Integration test verifies the full execution path: BrokerGateway -> RiskGate -> OrderManager -> FillJournal"
    - "Paper trading connects to IB Gateway on port 4002 and can place/cancel a test order"
    - "The 4-week paper trading plan is documented with monitoring schedule and success criteria"
    - "Self-healing cycle can fire during paper trading: agent detects drift, experiments, promotes"
  artifacts:
    - path: "tests/test_integration_execution.py"
      provides: "Integration test for full execution pipeline"
    - path: "src/hydra/execution/runner.py"
      provides: "Verified paper trading runner"
    - path: ".planning/phases/05-execution-hardening/PAPER_TRADING_PLAN.md"
      provides: "4-week paper trading monitoring and gate criteria"
  key_links:
    - from: "src/hydra/execution/runner.py"
      to: "IB Gateway"
      via: "ib_async connection on port 4002"
      pattern: "connectAsync"
---

<objective>
Validate the complete execution pipeline with integration tests and prepare for the 4-week paper trading validation period.

Purpose: This is the final checkpoint before the 4-week paper trading period begins. EXEC-01 requires the pipeline to use the same execution path as live. EXEC-05 requires 4+ weeks of stable paper trading with a self-healing cycle. This plan creates integration tests that verify the full pipeline works end-to-end, and a human-verify checkpoint to confirm IB Gateway connectivity.

Output: Integration tests, verified IB connectivity, documented monitoring plan for 4-week period.
</objective>

<execution_context>
@/Users/tristanfarmer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tristanfarmer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-execution-hardening/05-RESEARCH.md
@.planning/phases/05-execution-hardening/05-01-SUMMARY.md
@.planning/phases/05-execution-hardening/05-02-SUMMARY.md
@.planning/phases/05-execution-hardening/05-03-SUMMARY.md
@.planning/phases/05-execution-hardening/05-04-SUMMARY.md
@src/hydra/execution/runner.py
@src/hydra/execution/broker.py
@src/hydra/execution/risk_gate.py
@src/hydra/execution/order_manager.py
@src/hydra/execution/fill_journal.py
@src/hydra/execution/reconciler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integration tests for full execution pipeline</name>
  <files>
    tests/test_integration_execution.py
  </files>
  <action>
    1. Create `tests/test_integration_execution.py` with integration tests:

    These tests verify the full pipeline works together, using mocked IB (no real IB Gateway needed for CI):

    **Test: full_pipeline_paper_order_flow**
    - Instantiate real BrokerGateway (port 4002, client_id 1).
    - Instantiate real CircuitBreakerManager with default config.
    - Instantiate real RiskGate wrapping broker and breakers.
    - Instantiate real OrderManager wrapping risk_gate.
    - Instantiate real FillJournal with tmp_path.
    - Mock `ib_async.IB` to simulate: connectAsync succeeds, placeOrder returns a mock Trade with mock fills.
    - Call `order_manager.route_order(...)` with safe risk params (all within thresholds).
    - Verify: risk_gate allowed the order, broker received it, fill_journal logged the fill.

    **Test: full_pipeline_risk_blocked**
    - Same setup, but set daily_pnl = -0.05 (exceeds -0.02 threshold).
    - Call route_order.
    - Verify: RiskGate blocked the order (returned None), broker.submit_order was NOT called, no fill logged.

    **Test: reconciler_integration**
    - Create FillJournal with tmp_path.
    - Insert 20 synthetic FillRecords with known predicted/actual slippage values.
    - Create SlippageReconciler wrapping the journal.
    - Call reconcile().
    - Verify bias, RMSE, and correlation match expected values within tolerance.

    **Test: runner_daily_cycle_mock**
    - Instantiate PaperTradingRunner with all mocked dependencies.
    - Call run_daily_cycle().
    - Verify: broker connection checked, agent_loop.run_cycle called, results returned.

    **Test: port_safety**
    - Verify BrokerGateway(port=4002).is_paper == True.
    - Verify BrokerGateway(port=4001).is_paper == False.
    - Verify PaperTradingRunner with trading_mode="live" raises ValueError without env var.

    Mark all tests that would need real IB with `@pytest.mark.skipif` and a condition checking for `IB_GATEWAY_HOST` env var. This way they can run in CI (mocked) and against real IB (integration).

    2. Add a `conftest.py` fixture or use existing one for a `mock_ib` fixture that patches `ib_async.IB`.
  </action>
  <verify>
    `cd /Users/tristanfarmer/Documents/HYDRA && python -m pytest tests/test_integration_execution.py -v` passes all tests.
  </verify>
  <done>
    Integration tests verify full execution pipeline: order flow, risk blocking, fill logging, slippage reconciliation, port safety. All tests pass with mocked IB. Tests can also run against real IB Gateway when available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PAPER_TRADING_PLAN.md -- 4-week monitoring and gate criteria</name>
  <files>
    .planning/phases/05-execution-hardening/PAPER_TRADING_PLAN.md
  </files>
  <action>
    Create `.planning/phases/05-execution-hardening/PAPER_TRADING_PLAN.md` documenting the 4-week paper trading validation period (EXEC-05):

    ## Structure

    **1. Overview**: 4-week minimum paper trading period before any live capital. Purpose: validate execution pipeline, calibrate slippage model, prove self-healing cycle works end-to-end.

    **2. Monitoring Schedule**:
    - Daily: Check fill journal for new fills, review any risk gate blocks, verify agent loop ran.
    - Weekly: Run `hydra fill-report --reconcile` to check slippage model calibration. Review agent cycle logs for drift events and healing actions. Check circuit breaker trigger history.
    - End of each week: Record weekly P&L (paper), number of trades, number of risk blocks, slippage bias trend.

    **3. Success Metrics (gate conditions for live capital)**:
    - Minimum 4 weeks continuous operation without manual intervention
    - Slippage model calibrated: `is_model_calibrated()` returns True (bias < 0.5, correlation > 0.3)
    - At least 1 successful self-healing cycle completed (drift detected -> hypothesis -> experiment -> promote/rollback)
    - No unrecoverable errors (crashes, data corruption, zombie connections)
    - Circuit breakers triggered correctly when thresholds crossed (verified via paper fills near limits)
    - Reconnection handling works: at least 1 successful auto-reconnect observed or simulated

    **4. Self-Healing Criteria**:
    - What constitutes drift: return distribution shift (KS test p < 0.05), prediction accuracy drop > 10% from baseline
    - Expected healing cadence: agent loop runs daily, drift check triggers ~weekly depending on market regime
    - Success = candidate model promoted OR correctly rolled back (both are valid outcomes)

    **5. Live Capital Gate Conditions** (ALL must be met):
    - 4+ weeks stable paper trading
    - Slippage model calibrated
    - Self-healing cycle proven
    - Human review of all metrics (checkpoint)
    - `HYDRA_LIVE_CONFIRMED=true` env var set explicitly

    **6. Escalation Procedures**:
    - If paper trading fails to connect for >24h: check IB Gateway, restart, verify port/client_id
    - If slippage model never calibrates: investigate fill data quality, increase minimum fills threshold
    - If self-healing never triggers: artificially inject drift scenario for testing, or extend paper period

    Use markdown with clear sections. This is an operational document, not code.
  </action>
  <verify>
    `ls -la /Users/tristanfarmer/Documents/HYDRA/.planning/phases/05-execution-hardening/PAPER_TRADING_PLAN.md` -- file exists.
    File contains sections for monitoring schedule, success metrics, self-healing criteria, and live capital gate conditions.
  </verify>
  <done>
    PAPER_TRADING_PLAN.md documents the 4-week paper trading validation period with monitoring schedule, slippage calibration targets, self-healing criteria, live capital gate conditions, and escalation procedures.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete execution pipeline and IB connectivity</name>
  <action>
    Human verifies the complete Phase 5 execution pipeline works end-to-end.
  </action>
  <what-built>
    Complete Phase 5 execution pipeline:
    - BrokerGateway wrapping ib_async with reconnection and paper/live port safety
    - RiskGate mandatory middleware enforcing circuit breaker checks on every order
    - OrderManager with limit-patience and custom TWAP routing for thin markets
    - FillJournal logging every fill with predicted/actual slippage
    - SlippageReconciler comparing predicted vs actual slippage
    - PaperTradingRunner orchestrating daily cycle with APScheduler
    - CLI paper-trade and fill-report commands
    - Integration tests verifying full pipeline
  </what-built>
  <how-to-verify>
    1. Run full test suite: `cd /Users/tristanfarmer/Documents/HYDRA && python -m pytest tests/ -v --tb=short`
       Expected: All tests pass (existing + new Phase 5 tests).

    2. Verify CLI commands exist:
       `python -m hydra.cli.app --help`
       Expected: Shows paper-trade and fill-report alongside existing commands.

    3. Verify module imports:
       `python -c "from hydra.execution import BrokerGateway, RiskGate, OrderManager, FillJournal, SlippageReconciler, PaperTradingRunner; print('All execution modules imported successfully')"`

    4. If IB Gateway is available (optional -- skip if not set up yet):
       a. Start IB Gateway in paper mode on port 4002.
       b. Run: `python -c "import asyncio; from hydra.execution import BrokerGateway; async def test(): g = BrokerGateway(); await g.connect(); print(f'Connected: {g.is_connected()}, Paper: {g.is_paper}'); await g.disconnect(); asyncio.run(test())"`
       c. Expected: "Connected: True, Paper: True"

    5. Verify no market orders anywhere in execution code:
       `grep -r "MarketOrder" src/hydra/execution/`
       Expected: No results.

    If all checks pass, type "approved" to complete Phase 5.
    If IB Gateway not available yet, that is OK -- approve with note "IB setup pending" and the 4-week paper trading period begins when IB is configured.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found during verification</resume-signal>
</task>

</tasks>

<verification>
- All unit tests pass: `python -m pytest tests/ -v`
- All execution modules import correctly
- CLI shows paper-trade and fill-report commands
- No MarketOrder usage anywhere in execution code
- Integration tests verify end-to-end pipeline with mocked IB
</verification>

<success_criteria>
- Full execution pipeline verified through integration tests
- All Phase 5 modules work together: broker -> risk gate -> order manager -> fill journal -> reconciler -> runner
- Port safety prevents accidental live trading
- Human confirms test suite passes and CLI commands work
- System is ready for 4-week paper trading validation period (EXEC-05)
</success_criteria>

<output>
After completion, create `.planning/phases/05-execution-hardening/05-05-SUMMARY.md`
</output>
