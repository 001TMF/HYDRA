---
phase: 02-signal-layer-baseline-model
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/hydra/risk/__init__.py
  - src/hydra/risk/slippage.py
  - src/hydra/risk/position_sizing.py
  - src/hydra/risk/circuit_breakers.py
  - tests/test_slippage.py
  - tests/test_position_sizing.py
  - tests/test_circuit_breakers.py
autonomous: true
requirements:
  - MODL-03
  - MODL-04
  - MODL-05

must_haves:
  truths:
    - "Volume-adaptive slippage = spread/2 + k * sigma * sqrt(V_order / V_daily) with configurable k (default 0.1)"
    - "Fractional Kelly sizing returns position as fraction of capital, capped at max_position_pct"
    - "Volume cap limits position to configurable % of 20-day average daily volume (default 2%)"
    - "Negative Kelly (negative edge) returns zero position"
    - "Circuit breakers transition ACTIVE -> TRIGGERED -> COOLDOWN -> ACTIVE"
    - "Four independent circuit breakers: max_daily_loss, max_drawdown, max_position_size, max_single_trade_loss"
    - "All circuit breakers checked pre-trade and return allow/deny decision"
  artifacts:
    - path: "src/hydra/risk/slippage.py"
      provides: "estimate_slippage function with square-root impact model"
      exports: ["estimate_slippage"]
    - path: "src/hydra/risk/position_sizing.py"
      provides: "fractional_kelly and volume_capped_position functions"
      exports: ["fractional_kelly", "volume_capped_position"]
    - path: "src/hydra/risk/circuit_breakers.py"
      provides: "CircuitBreaker class with state machine and CircuitBreakerManager"
      exports: ["CircuitBreaker", "CircuitBreakerState", "CircuitBreakerManager"]
    - path: "src/hydra/risk/__init__.py"
      provides: "Public re-exports for risk module"
  key_links:
    - from: "src/hydra/risk/slippage.py"
      to: "walk_forward.py (Plan 02-05)"
      via: "called for every simulated trade in backtest loop"
      pattern: "estimate_slippage"
    - from: "src/hydra/risk/circuit_breakers.py"
      to: "walk_forward.py (Plan 02-05)"
      via: "checked pre-trade in backtest loop"
      pattern: "check_trade|is_trading_allowed"
---

<objective>
Build the risk management infrastructure: volume-adaptive slippage model, fractional Kelly position sizing with volume cap, and circuit breaker state machine with 4 independent breakers.

Purpose: These modules are used by the walk-forward backtester (Plan 02-05) to produce realistic, slippage-adjusted backtest results. They are also the runtime risk layer for paper trading in Phase 5.

Output: Three tested modules in `src/hydra/risk/` -- slippage.py, position_sizing.py, circuit_breakers.py.
</objective>

<execution_context>
@/Users/tristanfarmer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tristanfarmer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-signal-layer-baseline-model/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Write failing tests for all three risk modules</name>
  <files>tests/test_slippage.py, tests/test_position_sizing.py, tests/test_circuit_breakers.py, src/hydra/risk/__init__.py</files>
  <action>
Create `src/hydra/risk/__init__.py` (empty for now).

**tests/test_slippage.py** (5+ tests):
1. **test_zero_order_size**: order_size=0 -> slippage = spread/2 only (no market impact)
2. **test_slippage_increases_with_order_size**: larger orders produce higher slippage
3. **test_slippage_scales_with_volatility**: higher daily_volatility increases market impact
4. **test_slippage_with_custom_k**: k=0.2 produces higher slippage than k=0.1 for same inputs
5. **test_slippage_formula_exact**: For known inputs (order_size=100, daily_volume=5000, spread=2.0, sigma=0.02, k=0.1), verify exact formula: spread/2 + k * sigma * sqrt(100/5000)

**tests/test_position_sizing.py** (6+ tests):
1. **test_negative_kelly_returns_zero**: win_prob < loss_prob with small b -> kelly <= 0 -> return 0
2. **test_half_kelly_default**: fraction=0.5 produces half of full Kelly
3. **test_capped_at_max_position_pct**: Even large edge capped at max_position_pct (default 10%)
4. **test_zero_win_prob_returns_zero**: win_prob=0 -> 0
5. **test_volume_capped_position_integer**: Returns integer contracts, rounded down
6. **test_volume_cap_limits_position**: If kelly_contracts > volume_cap, use volume_cap

**tests/test_circuit_breakers.py** (7+ tests):
1. **test_initial_state_is_active**: New breaker starts in ACTIVE state
2. **test_daily_loss_triggers_breaker**: Loss exceeding daily_loss threshold triggers breaker
3. **test_drawdown_triggers_breaker**: Drawdown exceeding threshold triggers breaker
4. **test_position_size_triggers_breaker**: Position exceeding max triggers breaker
5. **test_single_trade_loss_triggers_breaker**: Single trade loss exceeding threshold triggers
6. **test_cooldown_resets_to_active**: After cooldown period, breaker transitions back to ACTIVE
7. **test_manager_checks_all_breakers**: CircuitBreakerManager denies trade if ANY breaker is triggered

Import from `hydra.risk.slippage`, `hydra.risk.position_sizing`, `hydra.risk.circuit_breakers`.

Run tests -- all MUST fail (RED phase).
  </action>
  <verify>`cd /Users/tristanfarmer/Documents/HYDRA && python -m pytest tests/test_slippage.py tests/test_position_sizing.py tests/test_circuit_breakers.py -v` shows ImportError or failures</verify>
  <done>Three test files exist with 18+ test cases total, all failing</done>
</task>

<task type="auto">
  <name>Task 2: GREEN + REFACTOR -- Implement slippage, position sizing, and circuit breakers</name>
  <files>src/hydra/risk/slippage.py, src/hydra/risk/position_sizing.py, src/hydra/risk/circuit_breakers.py, src/hydra/risk/__init__.py</files>
  <action>
**src/hydra/risk/slippage.py**:
```python
def estimate_slippage(order_size, daily_volume, spread, daily_volatility, impact_coefficient=0.1) -> float:
    """Volume-adaptive slippage: spread/2 + k * sigma * sqrt(V_order / V_daily)"""
```
Follow research code example exactly. Guard against daily_volume=0 with max(daily_volume, 1).

**src/hydra/risk/position_sizing.py**:
```python
def fractional_kelly(win_prob, avg_win, avg_loss, fraction=0.5, max_position_pct=0.10) -> float:
    """f* = (p*b - q) / b, return fraction * f* capped at max_position_pct."""

def volume_capped_position(kelly_pct, capital, contract_value, avg_daily_volume, max_volume_pct=0.02) -> int:
    """Convert Kelly % to integer contracts, capped by volume."""
```
Follow research code exactly. Negative Kelly returns 0.0. Volume cap = int(max_volume_pct * avg_daily_volume).

**src/hydra/risk/circuit_breakers.py**:
```python
class CircuitBreakerState(Enum):
    ACTIVE = "active"
    TRIGGERED = "triggered"
    COOLDOWN = "cooldown"

class CircuitBreaker:
    """Single circuit breaker with threshold and cooldown."""
    def __init__(self, name, threshold, cooldown_periods=1):
    def check(self, current_value) -> bool:  # True = OK to trade
    def update(self):  # Called each period to advance cooldown

class CircuitBreakerManager:
    """Manages 4 independent breakers: daily_loss, drawdown, position_size, single_trade_loss."""
    def __init__(self, config: dict):  # config has thresholds for each
    def check_trade(self, daily_pnl, peak_equity, current_equity, position_value, trade_loss) -> tuple[bool, list[str]]:
        # Returns (allowed, list_of_triggered_breaker_names)
    def advance_period(self):  # Advance cooldown for all breakers
```

State machine: ACTIVE -> TRIGGERED (when threshold breached) -> COOLDOWN (after one check when triggered) -> ACTIVE (after cooldown_periods).

Default config:
- max_daily_loss: -0.02 (2% of capital)
- max_drawdown: -0.05 (5% from peak)
- max_position_size: 0.10 (10% of capital in one position)
- max_single_trade_loss: -0.01 (1% of capital per trade)

Update `__init__.py` to re-export all public classes and functions.

Run all tests -- they MUST pass (GREEN). Refactor for clean code.
  </action>
  <verify>`cd /Users/tristanfarmer/Documents/HYDRA && python -m pytest tests/test_slippage.py tests/test_position_sizing.py tests/test_circuit_breakers.py -v` -- all tests pass</verify>
  <done>All 18+ risk module tests pass. Slippage uses square-root impact model. Kelly sizing with volume cap works. Circuit breakers implement full state machine.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/tristanfarmer/Documents/HYDRA
python -m pytest tests/test_slippage.py tests/test_position_sizing.py tests/test_circuit_breakers.py -v
python -c "from hydra.risk import estimate_slippage, fractional_kelly, CircuitBreakerManager; print('Import OK')"
```
</verification>

<success_criteria>
- estimate_slippage implements spread/2 + k * sigma * sqrt(participation_rate) exactly
- fractional_kelly returns 0 for negative edge, caps at max_position_pct
- volume_capped_position returns integer contracts within volume cap
- Circuit breakers implement ACTIVE -> TRIGGERED -> COOLDOWN -> ACTIVE state machine
- CircuitBreakerManager checks all 4 breakers and returns deny if any triggered
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-signal-layer-baseline-model/02-02-SUMMARY.md`
</output>
