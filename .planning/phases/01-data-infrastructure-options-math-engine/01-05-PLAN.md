---
phase: 01-data-infrastructure-options-math-engine
plan: 05
type: tdd
wave: 3
depends_on:
  - 01-01
files_modified:
  - src/hydra/signals/options_math/greeks.py
  - tests/test_greeks_flow.py
autonomous: true
requirements:
  - OPTS-04
  - OPTS-05

must_haves:
  truths:
    - "Black-76 gamma, vanna, and charm are computed correctly for individual options (verified against known values)"
    - "GEX aggregation sums per-strike gamma * OI * contract_multiplier * spot^2 / 100 across full chain"
    - "Vanna and charm flow aggregation uses correct sign convention (dealer-short assumption)"
    - "Greeks flow handles missing/zero OI strikes gracefully (skips them, no division by zero)"
    - "When liquid strike count < 8, Greeks flow returns degraded result with zero flows and a warning"
  artifacts:
    - path: "src/hydra/signals/options_math/greeks.py"
      provides: "Black-76 Greeks and aggregated flow computation (GEX, vanna, charm)"
      exports: ["black76_greeks", "compute_greeks_flow", "GreeksFlowResult"]
      min_lines: 100
    - path: "tests/test_greeks_flow.py"
      provides: "TDD tests for Greeks computation and flow aggregation"
      min_lines: 80
  key_links:
    - from: "src/hydra/signals/options_math/greeks.py"
      to: "scipy.stats.norm"
      via: "Normal distribution PDF/CDF for Black-76 Greeks"
      pattern: "norm\\.pdf|norm\\.cdf"
---

<objective>
Implement Black-76 Greeks computation and aggregated flow metrics (GEX, vanna, charm) using TDD.

Purpose: Greeks flows represent market maker hedging pressure and predict short-term price dynamics. GEX (gamma exposure) indicates whether dealers will amplify or dampen price moves. Vanna and charm flows predict how the hedging pressure will change with vol moves and time decay. These are Phase 2 features for the divergence signal.

Output: Working Greeks calculator at the individual option level, and aggregated flow metrics across the full options chain with correct dealer-short sign conventions and graceful degradation.
</objective>

<execution_context>
@/Users/tristanfarmer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tristanfarmer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-data-infrastructure-options-math-engine/01-RESEARCH.md
</context>

<feature>
  <name>Black-76 Greeks and Aggregated Flow Metrics</name>
  <files>
    src/hydra/signals/options_math/greeks.py
    tests/test_greeks_flow.py
  </files>
  <behavior>
    **Individual Greeks (Black-76):**
    black76_greeks(F, K, r, T, sigma, is_call) -> dict with gamma, vanna, charm, delta, vega

    Cases:
    1. ATM call (F=K=100, r=0.05, T=0.25, sigma=0.30): gamma > 0, verify against analytic formula
    2. Deep OTM put: gamma near zero
    3. T near zero: gamma very high for ATM (gamma blowup near expiry)
    4. Zero vol (sigma -> 0): should not crash (handle edge case)
    5. Known value check: For specific inputs, gamma = discount * N'(d1) / (F * sigma * sqrt(T))

    **Aggregated Flow:**
    compute_greeks_flow(chain: dict, spot: float, r: float, contract_multiplier: float, min_liquid_strikes: int = 8, max_spread_pct: float = 0.20, min_oi: int = 50) -> GreeksFlowResult

    chain dict has: strikes, call_ivs, put_ivs, call_oi, put_oi, expiries_T, bid_ask_spread_pct

    Cases:
    1. Simple 2-strike chain (known values): Verify GEX = sum of per-strike contributions
    2. Full chain (20 strikes): GEX, vanna, charm all non-NaN
    3. Sparse chain (5 liquid strikes): Returns quality=DEGRADED, flows = 0.0
    4. Zero OI strikes: Skipped without error
    5. Expired options (T <= 0): Skipped without error

    GreeksFlowResult dataclass: gex, vanna_flow, charm_flow, quality, liquid_strike_count, warnings

    Sign convention (per research):
    - Dealer assumed net short options (customers buy, dealers sell)
    - Calls: dealer short -> sign = +1 for GEX (positive gamma)
    - Puts: dealer short -> sign = -1 for GEX (negative gamma)
  </behavior>
  <implementation>
    **greeks.py** (follows research code example closely):

    Import DataQuality from density.py to reuse the same enum.

    black76_greeks(F, K, r, T, sigma, is_call) -> dict:
    - Guard: if T <= 1e-10 or sigma <= 1e-10, return zeros with warning
    - d1 = (ln(F/K) + 0.5*sigma^2*T) / (sigma*sqrt(T))
    - d2 = d1 - sigma*sqrt(T)
    - discount = exp(-rT)
    - gamma = discount * norm.pdf(d1) / (F * sigma * sqrt(T))
    - vanna = -discount * norm.pdf(d1) * d2 / sigma
    - charm = -discount * norm.pdf(d1) * (2*r*T - d2*sigma*sqrt(T)) / (2*T*sigma*sqrt(T))
    - delta (for calls: discount * norm.cdf(d1), puts: discount * (norm.cdf(d1) - 1))
    - vega = F * discount * norm.pdf(d1) * sqrt(T)

    compute_greeks_flow(chain, spot, r, contract_multiplier, ...):
    1. Filter to liquid strikes (same criteria as density.py: OI >= min_oi, spread <= max_spread_pct)
    2. If liquid_count < min_liquid_strikes: return DEGRADED result
    3. Loop over strikes, compute per-strike gamma/vanna/charm for both calls and puts
    4. GEX per strike = sign * gamma * OI * contract_multiplier * spot^2 / 100
    5. Vanna per strike = sign * vanna * OI * contract_multiplier * spot
    6. Charm per strike = sign * charm * OI * contract_multiplier
    7. Sum across all strikes for totals
    8. Skip T <= 0 or T > 2.0 (expired or too far out)
    9. Return GreeksFlowResult with quality=FULL

    All operations on NumPy arrays for performance. No Pandas.
  </implementation>
</feature>

<verification>
1. `uv run pytest tests/test_greeks_flow.py -v` -- all tests pass
2. ATM gamma matches analytic Black-76 formula (within 1e-6)
3. GEX for 2-strike chain matches hand calculation
4. Degradation: 5 liquid strikes returns quality=DEGRADED, flows=0.0
5. Zero OI and expired options are skipped without errors
</verification>

<success_criteria>
- Black-76 Greeks (gamma, vanna, charm, delta, vega) computed correctly for individual options
- Aggregated GEX, vanna flow, charm flow computed across full chain with dealer-short convention
- Graceful degradation when < 8 liquid strikes
- Edge cases (zero OI, expired options, near-zero vol) handled without crashes
- All TDD tests pass (RED -> GREEN -> REFACTOR cycle)
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-infrastructure-options-math-engine/01-05-SUMMARY.md`
</output>
