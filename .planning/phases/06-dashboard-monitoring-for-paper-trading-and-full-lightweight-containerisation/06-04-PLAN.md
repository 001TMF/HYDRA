---
phase: 06-dashboard-monitoring-for-paper-trading-and-full-lightweight-containerisation
plan: 04
type: execute
wave: 3
depends_on: ["06-03"]
files_modified:
  - tests/test_dashboard_pages.py
  - tests/test_dashboard_api.py
  - src/hydra/cli/app.py
  - src/hydra/dashboard/app.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "All dashboard page routes return 200 with HTML content"
    - "API endpoints return valid responses with and without data"
    - "CLI 'serve' command starts the dashboard via uvicorn"
    - "Dashboard handles missing databases without crashing"
    - "All existing tests remain passing"
  artifacts:
    - path: "tests/test_dashboard_pages.py"
      provides: "Tests for all 5 page routes with and without data"
    - path: "tests/test_dashboard_api.py"
      provides: "Tests for API endpoints (fills/recent, agent/state, system/status)"
    - path: "src/hydra/cli/app.py"
      provides: "CLI 'serve' command for starting the dashboard"
      contains: "def serve"
  key_links:
    - from: "src/hydra/cli/app.py"
      to: "src/hydra/dashboard/app.py"
      via: "CLI serve command imports and runs create_app"
      pattern: "create_app"
    - from: "tests/test_dashboard_pages.py"
      to: "src/hydra/dashboard/routes/pages.py"
      via: "httpx AsyncClient testing page routes"
      pattern: "async_client"
---

<objective>
Write comprehensive tests for all dashboard pages and API endpoints, then add a CLI `serve` command that starts the dashboard via uvicorn. This completes the dashboard integration with the existing HYDRA CLI.

Purpose: Ensure dashboard reliability through automated testing and provide a simple CLI entry point for starting the monitoring interface.
Output: Test suites for pages and API endpoints, CLI serve command, verified integration.
</objective>

<execution_context>
@/Users/tristanfarmer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tristanfarmer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dashboard-monitoring-for-paper-trading-and-full-lightweight-containerisation/06-01-SUMMARY.md
@.planning/phases/06-dashboard-monitoring-for-paper-trading-and-full-lightweight-containerisation/06-03-SUMMARY.md
@src/hydra/dashboard/app.py
@src/hydra/dashboard/routes/pages.py
@src/hydra/dashboard/routes/api.py
@src/hydra/cli/app.py
@tests/test_dashboard_app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write tests for all dashboard page routes and API endpoints</name>
  <files>
    tests/test_dashboard_pages.py
    tests/test_dashboard_api.py
  </files>
  <action>
    **Create `tests/test_dashboard_pages.py`:**

    Use the same `httpx.AsyncClient` + `ASGITransport` pattern from 06-01 tests. Create fixtures that optionally populate databases with test data.

    Fixtures:
    - `app_empty(tmp_path)` -- create_app with empty data_dir
    - `app_with_data(tmp_path)` -- create_app with pre-populated FillJournal (5 test fills) and ExperimentJournal (3 test experiments)
    - `async_client_empty(app_empty)` and `async_client_data(app_with_data)` -- httpx clients

    For `app_with_data`, populate:
    - FillJournal: insert 5 FillRecord entries with varied symbols, directions, slippage values
    - ExperimentJournal: insert 3 ExperimentRecord entries with varied mutation types and outcomes

    Page tests (each with empty and populated variants):

    1. `test_index_empty` -- GET `/`, assert 200, assert "HYDRA" in body, assert "0" fill count displayed.
    2. `test_index_with_data` -- GET `/`, assert 200, assert fill count > 0 in body.
    3. `test_fills_page_empty` -- GET `/fills`, assert 200, assert "No fills" or "0 fills" in body.
    4. `test_fills_page_with_data` -- GET `/fills`, assert 200, assert table rows present (look for `<tr>` or fill symbols).
    5. `test_agent_page_empty` -- GET `/agent`, assert 200, assert "paused" in body (default state).
    6. `test_agent_page_with_data` -- GET `/agent`, assert 200, assert experiment data visible.
    7. `test_drift_page` -- GET `/drift`, assert 200, assert "Drift" in body, assert "Sharpe" in body.
    8. `test_system_page_empty` -- GET `/system`, assert 200, assert "unavailable" in body.
    9. `test_system_page_with_data` -- GET `/system`, assert 200, assert "ok" in body.
    10. `test_all_pages_return_html` -- loop over ["/", "/fills", "/agent", "/drift", "/system"], GET each, assert 200 and "text/html" content type.

    **Create `tests/test_dashboard_api.py`:**

    API endpoint tests:

    1. `test_fills_recent_empty` -- GET `/api/fills/recent`, assert 200.
    2. `test_fills_recent_with_data` -- GET `/api/fills/recent` with populated journal, assert 200, assert response contains fill data.
    3. `test_agent_state_endpoint` -- GET `/api/agent/state`, assert 200, assert response contains "paused" or "running".
    4. `test_system_status_endpoint` -- GET `/api/system/status`, assert 200, assert JSON response has expected keys.
    5. `test_health_with_populated_dbs` -- GET `/api/health` with both DBs populated, assert 200, assert all "ok".
    6. `test_fills_summary_with_data` -- GET `/api/fills/summary` with populated journal, assert `fill_count > 0`.

    All tests use `@pytest.mark.asyncio` decorator.
  </action>
  <verify>
    Run `cd /Users/tristanfarmer/Documents/HYDRA && uv run pytest tests/test_dashboard_pages.py tests/test_dashboard_api.py -v` -- all tests pass.
  </verify>
  <done>
    16+ tests cover all 5 page routes (empty and populated states) and all API endpoints. Dashboard handles missing databases gracefully in all test scenarios.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI 'serve' command and verify full integration</name>
  <files>
    src/hydra/cli/app.py
    src/hydra/dashboard/app.py
  </files>
  <action>
    **Update `src/hydra/cli/app.py`** -- add a `serve` command:

    ```python
    @app.command()
    def serve(
        port: int = typer.Option(8080, help="Dashboard port"),
        host: str = typer.Option("127.0.0.1", help="Bind address (localhost only for security)"),
        data_dir: Optional[str] = typer.Option(None, help="Data directory for SQLite databases"),
    ) -> None:
        """Start the HYDRA monitoring dashboard."""
        import uvicorn
        from hydra.dashboard.app import create_app

        if data_dir is None:
            import pathlib
            data_dir = str(pathlib.Path.home() / ".hydra")

        # Create the app to validate config before starting uvicorn
        _app = create_app(data_dir=data_dir)

        console.print(
            Panel(
                f"[bold green]HYDRA Dashboard[/bold green]\n\n"
                f"  URL:      http://{host}:{port}\n"
                f"  Data dir: {data_dir}\n\n"
                "[dim]Read-only monitoring. Control via CLI commands.[/dim]\n"
                "[dim]Press Ctrl+C to stop.[/dim]",
                title="Dashboard Starting",
                border_style="green",
            )
        )

        uvicorn.run(
            "hydra.dashboard.app:create_app",
            host=host,
            port=port,
            factory=True,
            log_level="info",
        )
    ```

    Import `Optional` is already at the top of the file. Add the `serve` command after the `fill-report` command block.

    **Update `src/hydra/dashboard/app.py`** -- add `HYDRA_DATA_DIR` env var support:

    In the `create_app` function, before resolving data_dir, check for the `HYDRA_DATA_DIR` environment variable:
    ```python
    import os
    def create_app(data_dir: str | None = None) -> FastAPI:
        if data_dir is None:
            data_dir = os.environ.get("HYDRA_DATA_DIR", "~/.hydra")
        resolved = Path(data_dir).expanduser()
        ...
    ```

    This allows the Docker container to configure data_dir via environment variable (set in docker-compose.yml) while the CLI can override it with the `--data-dir` flag.
  </action>
  <verify>
    Run `cd /Users/tristanfarmer/Documents/HYDRA && uv run hydra serve --help` to verify the serve command is registered and shows help text.
    Run `cd /Users/tristanfarmer/Documents/HYDRA && uv run pytest tests/ -x -q` to verify ALL tests pass (existing + new dashboard tests).
  </verify>
  <done>
    CLI `hydra serve` command starts the dashboard on localhost:8080. HYDRA_DATA_DIR env var allows Docker container configuration. All tests pass including existing 547+ tests and new dashboard tests.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_dashboard_pages.py tests/test_dashboard_api.py -v` -- all new tests pass.
2. `uv run pytest tests/ -x -q` -- ALL tests pass (existing + new).
3. `uv run hydra serve --help` -- shows serve command with port, host, data-dir options.
4. `uv run hydra --help` -- lists serve command alongside existing commands.
</verification>

<success_criteria>
- 16+ new tests cover all page routes and API endpoints with empty and populated data
- CLI `hydra serve` command starts the dashboard with configurable port, host, and data directory
- HYDRA_DATA_DIR environment variable works for Docker container configuration
- All existing tests remain passing (547+)
- Dashboard gracefully handles missing databases in all test scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard-monitoring-for-paper-trading-and-full-lightweight-containerisation/06-04-SUMMARY.md`
</output>
