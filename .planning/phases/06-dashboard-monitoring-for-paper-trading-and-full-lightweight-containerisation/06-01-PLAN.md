---
phase: 06-dashboard-monitoring-for-paper-trading-and-full-lightweight-containerisation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/hydra/dashboard/__init__.py
  - src/hydra/dashboard/app.py
  - src/hydra/dashboard/routes/__init__.py
  - src/hydra/dashboard/routes/pages.py
  - src/hydra/dashboard/routes/api.py
  - src/hydra/dashboard/routes/sse.py
  - src/hydra/dashboard/templates/base.html
  - src/hydra/dashboard/static/style.css
  - tests/test_dashboard_app.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "FastAPI dashboard app starts and responds to HTTP requests on port 8080"
    - "Health endpoint returns JSON with status checks for SQLite databases"
    - "Base HTML template loads htmx from CDN and provides navigation skeleton"
    - "SSE endpoint streams events to connected clients"
  artifacts:
    - path: "src/hydra/dashboard/app.py"
      provides: "FastAPI app factory with route registration, static/template mounts"
      exports: ["create_app"]
    - path: "src/hydra/dashboard/routes/pages.py"
      provides: "HTML page routes with Jinja2 template rendering"
    - path: "src/hydra/dashboard/routes/api.py"
      provides: "JSON API endpoints for dashboard data + health check"
      exports: ["router"]
    - path: "src/hydra/dashboard/routes/sse.py"
      provides: "SSE streaming endpoint for live dashboard updates"
      exports: ["router"]
    - path: "src/hydra/dashboard/templates/base.html"
      provides: "Base layout with htmx CDN, nav bar, content block"
    - path: "src/hydra/dashboard/static/style.css"
      provides: "Minimal CSS for dashboard layout"
    - path: "tests/test_dashboard_app.py"
      provides: "Tests for app factory, health endpoint, route registration"
  key_links:
    - from: "src/hydra/dashboard/app.py"
      to: "src/hydra/dashboard/routes/pages.py"
      via: "include_router"
      pattern: "app\\.include_router\\(pages\\.router\\)"
    - from: "src/hydra/dashboard/app.py"
      to: "src/hydra/dashboard/templates/base.html"
      via: "Jinja2Templates directory mount"
      pattern: "Jinja2Templates"
    - from: "src/hydra/dashboard/routes/api.py"
      to: "src/hydra/execution/fill_journal.py"
      via: "FillJournal import for health check"
      pattern: "FillJournal"
---

<objective>
Create the FastAPI dashboard application skeleton with app factory, route structure, health endpoint, base HTML template with htmx CDN, SSE infrastructure, and static files. This is the foundation that all dashboard pages will build on.

Purpose: Establish the web application framework so subsequent plans can add page-specific routes and templates without touching the foundation.
Output: A working FastAPI app that starts, serves a base HTML page, returns health JSON, and streams SSE events. Tests verify app creation and health endpoint.
</objective>

<execution_context>
@/Users/tristanfarmer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tristanfarmer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dashboard-monitoring-for-paper-trading-and-full-lightweight-containerisation/06-RESEARCH.md
@src/hydra/execution/fill_journal.py
@src/hydra/sandbox/journal.py
@src/hydra/cli/state.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FastAPI app factory with route registration, templates, static files, and health endpoint</name>
  <files>
    pyproject.toml
    src/hydra/dashboard/__init__.py
    src/hydra/dashboard/app.py
    src/hydra/dashboard/routes/__init__.py
    src/hydra/dashboard/routes/pages.py
    src/hydra/dashboard/routes/api.py
    src/hydra/dashboard/templates/base.html
    src/hydra/dashboard/static/style.css
  </files>
  <action>
    1. Add dashboard dependencies to pyproject.toml: `fastapi>=0.115.0`, `uvicorn>=0.34.0`, `jinja2>=3.1.6`, `sse-starlette>=2.0`. Do NOT remove any existing dependencies.

    2. Create `src/hydra/dashboard/__init__.py` (empty).

    3. Create `src/hydra/dashboard/app.py` with a `create_app(data_dir: str = "~/.hydra") -> FastAPI` factory:
       - Create FastAPI instance with `title="HYDRA Dashboard"`, `docs_url=None`, `redoc_url=None` (no Swagger UI -- this is a monitoring tool).
       - Resolve `data_dir` using `Path(data_dir).expanduser()` and store on `app.state.data_dir`.
       - Create `Jinja2Templates` from `Path(__file__).parent / "templates"` and store on `app.state.templates`.
       - Mount `StaticFiles` from `Path(__file__).parent / "static"` at `/static`.
       - Include routers: `pages.router` (no prefix), `api.router` (prefix `/api`), `sse.router` (prefix `/api/sse`).
       - The factory pattern allows tests to create isolated app instances with temp directories.

    4. Create `src/hydra/dashboard/routes/__init__.py` (empty).

    5. Create `src/hydra/dashboard/routes/pages.py` with an APIRouter:
       - `GET /` -- index page. For now, render `base.html` with `{"request": request, "page_title": "Overview"}`. The full overview content comes in plan 06-03.

    6. Create `src/hydra/dashboard/routes/api.py` with an APIRouter:
       - `GET /health` -- health check endpoint. Returns JSON dict with:
         - `"api": "ok"` (always)
         - `"fill_journal": "ok"` or `"unavailable"` (try opening FillJournal at `app.state.data_dir / "fill_journal.db"`, catch exceptions)
         - `"experiment_journal": "ok"` or `"unavailable"` (try opening ExperimentJournal at `app.state.data_dir / "experiment_journal.db"`, catch exceptions)
         - `"agent_state": get_state().value` (from `hydra.cli.state`)
         - Return status 200 if all "ok", 503 if any "unavailable".
         - Close any opened DB connections in a finally block.
       - `GET /fills/summary` -- returns JSON with `fill_count` and `recent_fills` (last 5). This powers the htmx polling fragment. Read from FillJournal, handle missing DB gracefully (return `{"fill_count": 0, "recent_fills": []}`).

    7. Create `src/hydra/dashboard/routes/sse.py` with an APIRouter:
       - `GET /cycle-status` -- SSE endpoint using `sse_starlette.sse.EventSourceResponse`.
         - Define an `async def event_generator()` that yields `{"event": "cycle_update", "data": json.dumps({"agent_state": get_state().value, "timestamp": datetime.now(UTC).isoformat()})}` every 60 seconds.
         - Check `await request.is_disconnected()` in the loop to break on client disconnect.
       - Import `json`, `asyncio`, `datetime` as needed.

    8. Create `src/hydra/dashboard/templates/base.html`:
       - Standard HTML5 boilerplate with `<meta charset="utf-8">`, viewport meta tag.
       - `<title>HYDRA - {% block title %}Dashboard{% endblock %}</title>`
       - `<link rel="stylesheet" href="/static/style.css">`
       - `<script src="https://unpkg.com/htmx.org@2.0.8/dist/htmx.min.js"></script>`
       - `<script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>`
       - Navigation bar with links: Overview (`/`), Fills (`/fills`), Agent (`/agent`), Drift (`/drift`), System (`/system`). Use simple `<nav><a>` elements.
       - `<main>{% block content %}{% endblock %}</main>`
       - Footer with "HYDRA Dashboard -- Read-only monitoring. Control via CLI."

    9. Create `src/hydra/dashboard/static/style.css`:
       - System font stack: `-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`
       - Dark theme: background `#1a1a2e`, text `#e0e0e0`, card background `#16213e`
       - Navigation: horizontal bar, active link highlight
       - `.card` class: padding, border-radius, subtle border
       - `.status-ok` green, `.status-warn` amber, `.status-alert` red
       - Keep it minimal -- under 100 lines. No animations per research guidance.
  </action>
  <verify>
    Run `cd /Users/tristanfarmer/Documents/HYDRA && uv sync` to install new dependencies.
    Run `uv run python -c "from hydra.dashboard.app import create_app; app = create_app(); print('App created:', app.title)"` to verify the app factory works.
  </verify>
  <done>
    FastAPI app factory creates a working application with pages, api, and sse routers mounted. Health endpoint exists at /api/health. Base HTML template includes htmx CDN and navigation. Static CSS serves dark theme styles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for dashboard app factory, health endpoint, and route registration</name>
  <files>
    tests/test_dashboard_app.py
  </files>
  <action>
    Create `tests/test_dashboard_app.py` using `httpx.AsyncClient` with FastAPI's `ASGITransport` (standard FastAPI test pattern, no external test server needed).

    Add `httpx` to dev dependencies in pyproject.toml if not already present.

    Tests:
    1. `test_create_app` -- call `create_app(data_dir=tmp_path)`, assert app.title == "HYDRA Dashboard", assert app.state.data_dir is a Path.

    2. `test_health_endpoint_no_databases` -- create app with empty tmp_path, GET `/api/health`, assert 503 status (no DBs exist), assert response JSON has "api": "ok" and at least one "unavailable".

    3. `test_health_endpoint_with_databases` -- create FillJournal and ExperimentJournal in tmp_path (they auto-create tables on init), close them, then GET `/api/health`, assert 200 status, assert all values "ok" or a valid agent_state string.

    4. `test_index_page_returns_html` -- GET `/`, assert 200 status, assert "HYDRA" in response text, assert "text/html" in content-type.

    5. `test_fills_summary_empty` -- GET `/api/fills/summary` with empty tmp_path, assert 200, assert `fill_count == 0`.

    6. `test_static_css_served` -- GET `/static/style.css`, assert 200 status.

    Use `pytest.fixture` for `tmp_path` and `async_client`:
    ```python
    @pytest.fixture
    def app(tmp_path):
        from hydra.dashboard.app import create_app
        return create_app(data_dir=str(tmp_path))

    @pytest.fixture
    async def async_client(app):
        from httpx import ASGITransport, AsyncClient
        transport = ASGITransport(app=app)
        async with AsyncClient(transport=transport, base_url="http://test") as client:
            yield client
    ```

    Mark async tests with `@pytest.mark.asyncio`.
  </action>
  <verify>
    Run `cd /Users/tristanfarmer/Documents/HYDRA && uv run pytest tests/test_dashboard_app.py -v` -- all 6 tests pass.
  </verify>
  <done>
    6 tests pass covering app creation, health endpoint (with and without databases), index page HTML response, fills summary API, and static file serving.
  </done>
</task>

</tasks>

<verification>
1. `uv sync` completes without errors (new dependencies installed).
2. `uv run python -c "from hydra.dashboard.app import create_app; print(create_app().title)"` prints "HYDRA Dashboard".
3. `uv run pytest tests/test_dashboard_app.py -v` -- all tests pass.
4. All 547 existing tests still pass: `uv run pytest tests/ -x --ignore=tests/test_dashboard_app.py -q`
</verification>

<success_criteria>
- FastAPI app factory creates working app with routes at /, /api/health, /api/fills/summary, /api/sse/cycle-status
- Health endpoint checks SQLite database availability and agent state
- Base HTML template includes htmx 2.0.8 CDN, SSE extension, navigation links
- Dark theme CSS serves from /static/style.css
- 6 new tests pass, 547 existing tests unbroken
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard-monitoring-for-paper-trading-and-full-lightweight-containerisation/06-01-SUMMARY.md`
</output>
