---
phase: 06-dashboard-monitoring-for-paper-trading-and-full-lightweight-containerisation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/Dockerfile
  - docker/docker-compose.yml
  - docker/.env.example
  - .dockerignore
  - .gitignore
autonomous: true
requirements: []

must_haves:
  truths:
    - "Docker image builds successfully from the project root"
    - "docker-compose.yml defines ib-gateway and hydra services with correct networking"
    - "IB credentials are loaded from .env file, not hardcoded in compose"
    - ".env file is git-ignored to prevent credential leaks"
    - "HYDRA container health check verifies dashboard is responsive"
  artifacts:
    - path: "docker/Dockerfile"
      provides: "Multi-stage Docker image for HYDRA using uv"
      contains: "FROM python"
    - path: "docker/docker-compose.yml"
      provides: "Two-service orchestration: ib-gateway + hydra"
      contains: "ghcr.io/gnzsnz/ib-gateway"
    - path: "docker/.env.example"
      provides: "Template for required environment variables with placeholder values"
      contains: "TWS_USERID"
    - path: ".dockerignore"
      provides: "Exclude unnecessary files from Docker build context"
    - path: ".gitignore"
      provides: "Updated to exclude .env and Docker runtime artifacts"
  key_links:
    - from: "docker/docker-compose.yml"
      to: "docker/Dockerfile"
      via: "build context reference"
      pattern: "build:"
    - from: "docker/docker-compose.yml"
      to: "docker/.env.example"
      via: "env_file directive"
      pattern: "env_file"
    - from: "docker/docker-compose.yml"
      to: "ghcr.io/gnzsnz/ib-gateway:stable"
      via: "image reference for IB Gateway container"
      pattern: "ghcr\\.io/gnzsnz/ib-gateway"
---

<objective>
Create Docker containerisation for the complete HYDRA + IB Gateway stack using Docker Compose. The HYDRA container runs both the dashboard and the paper trading runner in a single process (SQLite WAL safety). The IB Gateway container uses the community gnzsnz image.

Purpose: Reproducible deployment of the full paper trading system on any Docker-capable host, with credentials managed securely via .env files.
Output: Dockerfile, docker-compose.yml, .env.example, .dockerignore, and updated .gitignore.
</objective>

<execution_context>
@/Users/tristanfarmer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tristanfarmer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dashboard-monitoring-for-paper-trading-and-full-lightweight-containerisation/06-RESEARCH.md
@pyproject.toml
@src/hydra/execution/runner.py
@src/hydra/execution/broker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile, docker-compose.yml, and environment configuration</name>
  <files>
    docker/Dockerfile
    docker/docker-compose.yml
    docker/.env.example
    .dockerignore
  </files>
  <action>
    1. Create `docker/Dockerfile`:
       ```dockerfile
       FROM python:3.11-slim AS base

       WORKDIR /app

       # Install uv for fast dependency management
       COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

       # Copy dependency files first for layer caching
       COPY pyproject.toml uv.lock ./

       # Install production dependencies (no dev group)
       RUN uv sync --frozen --no-dev

       # Copy source code
       COPY src/ ./src/

       # Create data directory for SQLite DBs and logs
       RUN mkdir -p /data/logs

       VOLUME /data

       EXPOSE 8080

       # Default: run dashboard via uvicorn (runner starts as lifespan event)
       CMD ["uv", "run", "uvicorn", "hydra.dashboard.app:create_app", \
            "--host", "0.0.0.0", "--port", "8080", "--factory"]
       ```
       Notes:
       - Use python:3.11-slim (matches project requires-python >=3.11).
       - Copy pyproject.toml + uv.lock first for Docker layer caching.
       - `uv sync --frozen --no-dev` installs production deps only.
       - Single CMD runs the dashboard; the PaperTradingRunner will be integrated as a FastAPI lifespan event in plan 06-03.

    2. Create `docker/docker-compose.yml`:
       ```yaml
       services:
         ib-gateway:
           image: ghcr.io/gnzsnz/ib-gateway:stable
           restart: always
           env_file: .env
           environment:
             TRADING_MODE: ${TRADING_MODE:-paper}
           ports:
             - "127.0.0.1:4002:4004"   # Paper API port (internal 4004 -> host 4002)
             - "127.0.0.1:5900:5900"   # VNC for debugging (optional)
           volumes:
             - ib-gateway-data:/root/ibc

         hydra:
           build:
             context: ..
             dockerfile: docker/Dockerfile
           restart: always
           depends_on:
             - ib-gateway
           env_file: .env
           environment:
             IB_GATEWAY_HOST: ib-gateway
             IB_GATEWAY_PORT: "4004"          # Internal container port (paper)
             HYDRA_DATA_DIR: /data
             TRADING_MODE: ${TRADING_MODE:-paper}
           volumes:
             - hydra-data:/data
           ports:
             - "127.0.0.1:8080:8080"          # Dashboard (localhost only)
           healthcheck:
             test: ["CMD", "python", "-c",
                    "import urllib.request; urllib.request.urlopen('http://localhost:8080/api/health')"]
             interval: 30s
             timeout: 5s
             retries: 3
             start_period: 15s

       volumes:
         hydra-data:       # fill_journal.db, experiment_journal.db, logs/
         ib-gateway-data:  # IBC config persistence
       ```
       Key decisions:
       - HYDRA connects to ib-gateway on internal port 4004 (paper) via Docker network hostname `ib-gateway`. No host port mapping needed for this connection.
       - Host port mapping 127.0.0.1:4002:4004 is for direct CLI access from the host machine.
       - Dashboard bound to 127.0.0.1:8080 (localhost only -- no auth needed).
       - Named volumes for data persistence across container restarts.
       - `start_period: 15s` gives uv + uvicorn time to start before health checks begin.

    3. Create `docker/.env.example`:
       ```
       # IB Gateway credentials (REQUIRED)
       # Get from your Interactive Brokers account
       TWS_USERID=your_ib_username
       TWS_PASSWORD=your_ib_password

       # Trading mode: "paper" (default) or "live"
       # WARNING: "live" mode uses real capital. Only set after 4+ weeks stable paper trading.
       TRADING_MODE=paper

       # IB Gateway 2FA method (optional, default: empty for no 2FA)
       # Options: "", "TOTP" (for IBKR Mobile app)
       TWS_TOTP_SECRET=

       # Dashboard bind (do not change unless you know what you're doing)
       DASHBOARD_PORT=8080
       ```

    4. Create `.dockerignore` at project root:
       ```
       .git
       .planning
       .claude
       .mypy_cache
       .pytest_cache
       .ruff_cache
       __pycache__
       *.pyc
       .env
       .env.*
       !.env.example
       tests/
       docker/
       *.md
       *.egg-info
       dist/
       build/
       ```
       Exclude planning, tests, docs, caches, and sensitive files from build context to keep the image small and secure.
  </action>
  <verify>
    Run `cd /Users/tristanfarmer/Documents/HYDRA && docker build -f docker/Dockerfile -t hydra:test .` to verify the Dockerfile builds (this will fail if Docker is not installed -- that's OK, the file structure is correct).
    If Docker is not available, verify syntax: `python -c "import yaml; yaml.safe_load(open('docker/docker-compose.yml'))"` (install pyyaml temporarily if needed, or just verify the file exists and is well-formed).
  </verify>
  <done>
    Dockerfile builds HYDRA image with uv + production dependencies. docker-compose.yml orchestrates ib-gateway + hydra services. .env.example provides credential template. .dockerignore excludes unnecessary files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update .gitignore to protect credentials and Docker runtime files</name>
  <files>
    .gitignore
  </files>
  <action>
    Read the existing `.gitignore` file. Append the following section if not already present:

    ```
    # Docker
    docker/.env
    .env
    *.env.local

    # Docker runtime
    docker/data/
    ```

    Do NOT remove any existing entries. Only add new lines.

    Also verify that `docker/.env.example` is NOT ignored (it should be committed as a template). The `.dockerignore` already handles `!.env.example` for the build context, but `.gitignore` should not have a pattern that blocks `.env.example`.
  </action>
  <verify>
    Run `cd /Users/tristanfarmer/Documents/HYDRA && git check-ignore docker/.env.example` -- should return no output (not ignored).
    Run `echo "test" > /tmp/test-env && cp /tmp/test-env docker/.env && git check-ignore docker/.env` -- should return `docker/.env` (is ignored). Clean up the test file afterward.
  </verify>
  <done>
    .gitignore updated to exclude .env files (credential protection) while allowing .env.example to be committed. Docker runtime data directories excluded.
  </done>
</task>

</tasks>

<verification>
1. `docker/Dockerfile` exists with correct Python 3.11 base, uv install, and uvicorn CMD.
2. `docker/docker-compose.yml` exists with ib-gateway and hydra services, named volumes, healthcheck.
3. `docker/.env.example` exists with placeholder IB credentials and TRADING_MODE=paper.
4. `.dockerignore` exists and excludes .git, tests, .planning, .env files.
5. `.gitignore` blocks `docker/.env` but allows `docker/.env.example`.
6. All 547 existing tests still pass (no source code changes in this plan).
</verification>

<success_criteria>
- Dockerfile builds a HYDRA image with production dependencies via uv
- docker-compose.yml defines two services with correct port mapping, env_file, volumes, and healthcheck
- IB credentials are securely managed via .env file excluded from version control
- .env.example is committed as a setup template for new deployments
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard-monitoring-for-paper-trading-and-full-lightweight-containerisation/06-02-SUMMARY.md`
</output>
