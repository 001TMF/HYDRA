---
phase: 03-sandbox-experiment-infrastructure
plan: 06
type: execute
wave: 2
depends_on: [03-02, 03-03, 03-04, 03-05]
files_modified:
  - src/hydra/cli/__init__.py
  - src/hydra/cli/app.py
  - src/hydra/cli/formatters.py
  - src/hydra/cli/state.py
  - tests/test_cli.py
  - pyproject.toml
autonomous: true
requirements: [CLI-01, CLI-02, CLI-03, CLI-04, CLI-05, CLI-06]

must_haves:
  truths:
    - "status command displays model health metrics, active experiment count, drift alerts, and autonomy level in a Rich table"
    - "diagnose command runs a drift check on the champion model and displays the DriftReport"
    - "rollback command calls ModelRegistry.rollback() and confirms the new champion version"
    - "pause and run commands toggle agent loop state via a JSON state file"
    - "journal command queries ExperimentJournal by tag, date, and mutation type and displays results in a Rich table"
    - "All CLI output uses Rich formatting with tables, colored alerts, and panels"
  artifacts:
    - path: "src/hydra/cli/app.py"
      provides: "Typer app entry point with all subcommands"
      exports: ["app"]
    - path: "src/hydra/cli/formatters.py"
      provides: "Rich formatters for status table, drift report, journal table"
      exports: ["format_status_table", "format_drift_report", "format_journal_table"]
    - path: "src/hydra/cli/state.py"
      provides: "Agent loop state management (pause/run via JSON file)"
      exports: ["AgentState", "get_state", "set_state"]
    - path: "tests/test_cli.py"
      provides: "Tests for all CLI commands using typer.testing.CliRunner"
  key_links:
    - from: "src/hydra/cli/app.py"
      to: "src/hydra/sandbox/registry.py"
      via: "status, rollback, diagnose commands use ModelRegistry"
      pattern: "ModelRegistry"
    - from: "src/hydra/cli/app.py"
      to: "src/hydra/sandbox/journal.py"
      via: "journal command uses ExperimentJournal.query()"
      pattern: "ExperimentJournal"
    - from: "src/hydra/cli/app.py"
      to: "src/hydra/sandbox/observer.py"
      via: "diagnose command uses DriftObserver"
      pattern: "DriftObserver"
    - from: "src/hydra/cli/app.py"
      to: "src/hydra/sandbox/evaluator.py"
      via: "status command shows fitness score from CompositeEvaluator"
      pattern: "CompositeEvaluator"
---

<objective>
Create the Typer CLI with all 6 commands (status, diagnose, rollback, pause, run, journal) using Rich-formatted terminal output.

Purpose: CLI-01 through CLI-06 provide the operator's window into the system. The CLI commands wire together all Phase 3 sandbox modules (registry, journal, observer, evaluator) into human-usable commands. This is the control surface for Phase 4's autonomous loop.

Output: `src/hydra/cli/` package with app.py, formatters.py, state.py, and test suite.
</objective>

<execution_context>
@/Users/tristanfarmer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tristanfarmer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sandbox-experiment-infrastructure/03-RESEARCH.md
@.planning/phases/03-sandbox-experiment-infrastructure/03-02-PLAN.md
@.planning/phases/03-sandbox-experiment-infrastructure/03-03-PLAN.md
@.planning/phases/03-sandbox-experiment-infrastructure/03-04-PLAN.md
@.planning/phases/03-sandbox-experiment-infrastructure/03-05-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI package with state management and Rich formatters</name>
  <files>src/hydra/cli/__init__.py, src/hydra/cli/state.py, src/hydra/cli/formatters.py, pyproject.toml</files>
  <action>
Add `"typer[all]>=0.12"` to `dependencies` in `pyproject.toml` (if not already present). Also add a `[project.scripts]` section: `hydra = "hydra.cli.app:app"` so the CLI is installable as `hydra` command. Run `uv sync`.

**`src/hydra/cli/__init__.py`**: Empty or minimal, just marks as package.

**`src/hydra/cli/state.py`** -- Agent loop state management:

1. `AgentState` enum: `RUNNING`, `PAUSED`.

2. `STATE_FILE` constant: `Path.home() / ".hydra" / "agent_state.json"`.

3. `get_state() -> AgentState`:
   - Read STATE_FILE if it exists.
   - Parse JSON, return AgentState from the `"state"` key.
   - If file doesn't exist, return `AgentState.PAUSED` (safe default).

4. `set_state(state: AgentState) -> None`:
   - Create parent directory if it doesn't exist (`STATE_FILE.parent.mkdir(parents=True, exist_ok=True)`).
   - Write JSON: `{"state": state.value, "updated_at": datetime.utcnow().isoformat()}`.

**`src/hydra/cli/formatters.py`** -- Rich output formatters:

1. `format_status_table(champion_info: dict | None, experiment_count: int, alerts: list[str], autonomy: str) -> Table`:
   - Rich Table with title "HYDRA System Status".
   - Columns: Metric, Value, Status.
   - Rows for champion model metrics (Sharpe, drawdown, hit rate) from champion_info.
   - Row for active experiments count.
   - Row for autonomy level.
   - Color coding: green for OK, yellow for WATCH, red for ALERT.

2. `format_drift_report(report) -> Panel`:
   - Rich Panel with title "Drift Report".
   - Performance metrics with color-coded status.
   - Feature drift summary (list of drifted features if any).
   - Streaming alerts.
   - Overall status: "[green]HEALTHY[/green]" or "[red]DRIFT DETECTED[/red]".

3. `format_journal_table(records: list) -> Table`:
   - Rich Table with title "Experiment Journal".
   - Columns: ID, Date, Hypothesis (truncated to 40 chars), Mutation, Decision, Sharpe.
   - Color code decision: green for promoted, red for rejected, yellow for pending.

4. `format_rollback_result(old_version: int, new_version: int) -> Panel`:
   - Panel showing rollback details.

All formatters accept data objects and return Rich renderables (Table, Panel). They do NOT call `console.print()` -- that's the caller's job. This keeps them testable.
  </action>
  <verify>
`python -c "from hydra.cli.state import AgentState, get_state, set_state; from hydra.cli.formatters import format_status_table; print('OK')"` succeeds.
  </verify>
  <done>CLI state management via JSON file, Rich formatters for status/drift/journal/rollback output. All formatters return Rich renderables.</done>
</task>

<task type="auto">
  <name>Task 2: Create Typer app with all 6 commands and test suite</name>
  <files>src/hydra/cli/app.py, tests/test_cli.py</files>
  <action>
**`src/hydra/cli/app.py`**:

Create the Typer app with commands. Each command handles its own error cases gracefully (missing champion, empty journal, etc.) with Rich-formatted error messages.

```python
import typer
from rich.console import Console

app = typer.Typer(name="hydra", help="HYDRA autonomous trading system CLI", rich_markup_mode="rich")
console = Console()
```

1. **status command** (CLI-01):
   - `@app.command()` `def status(registry_uri: str = typer.Option(None), journal_path: str = typer.Option(None)):`
   - Create ModelRegistry (with registry_uri if provided).
   - Try to get champion_info. If no champion, show "No champion model set" panel.
   - Count experiments from journal (if journal_path provided).
   - Get agent state (running/paused).
   - Call `format_status_table()` and print.

2. **diagnose command** (CLI-02):
   - `@app.command()` `def diagnose(registry_uri: str = typer.Option(None)):`
   - Load champion model info from registry.
   - Create DriftObserver.
   - Run check_performance_drift with whatever data is available (or show instructions if no data).
   - Print DriftReport via `format_drift_report()`.
   - NOTE: For Phase 3, diagnose shows the drift detection infrastructure working. Full diagnostic cycle with live data is Phase 4.

3. **rollback command** (CLI-03):
   - `@app.command()` `def rollback(registry_uri: str = typer.Option(None)):`
   - Get current champion version before rollback.
   - Call `registry.rollback()`.
   - Print rollback result via `format_rollback_result()`.
   - Handle ValueError (no archived model) with error message.

4. **pause command** (CLI-04):
   - `@app.command()` `def pause():`
   - Call `set_state(AgentState.PAUSED)`.
   - Print "[yellow]Agent loop PAUSED[/yellow]" panel.

5. **run command** (CLI-04):
   - `@app.command(name="run")` `def run_agent():`
   - Call `set_state(AgentState.RUNNING)`.
   - Print "[green]Agent loop RUNNING[/green]" panel.

6. **journal command** (CLI-05):
   - `@app.command()` `def journal(journal_path: str = typer.Option(None), tag: str = typer.Option(None), since: str = typer.Option(None), until: str = typer.Option(None), mutation: str = typer.Option(None), outcome: str = typer.Option(None), limit: int = typer.Option(20)):`
   - Create ExperimentJournal.
   - Build query kwargs from provided options.
   - Call `journal.query()`.
   - Print results via `format_journal_table()`.
   - Show count of results.

**`tests/test_cli.py`**:

Use `typer.testing.CliRunner` for all tests. Use `tmp_path` for registry and journal paths.

1. **test_status_no_champion**: Invoke `status` with fresh (empty) registry. Assert exit code 0, output contains "No champion" or similar.

2. **test_pause_and_run**: Invoke `pause`, assert output contains "PAUSED". Invoke `run`, assert output contains "RUNNING". Read state file to verify.

3. **test_rollback_no_archived**: Invoke `rollback` with empty registry. Assert exit code 0 (handled gracefully), output contains error message.

4. **test_journal_empty**: Invoke `journal` with empty journal. Assert exit code 0, output indicates no results.

5. **test_journal_with_data**: Pre-populate a journal with 3 records. Invoke `journal`. Assert output contains experiment data.

6. **test_journal_filtered**: Pre-populate journal with varied records. Invoke `journal --mutation hyperparameter`. Assert output only shows matching records.

7. **test_cli_help**: Invoke `--help`. Assert exit code 0, output lists all commands.

Use monkeypatch or env vars to inject tmp_path-based paths for registry and journal in tests.
  </action>
  <verify>
```bash
python -m pytest tests/test_cli.py -v
python -c "from hydra.cli.app import app; print('OK')"
```
All tests pass.
  </verify>
  <done>Typer app with 6 commands (status, diagnose, rollback, pause, run, journal). All commands use Rich formatting. 7 tests cover all commands including error handling. CLI installable as `hydra` command.</done>
</task>

</tasks>

<verification>
```bash
python -m pytest tests/test_cli.py -v
python -c "from hydra.cli.app import app; print(type(app))"
python -m hydra.cli.app --help  # or: hydra --help after uv install
```
All tests pass. CLI commands work with Rich-formatted output.
</verification>

<success_criteria>
1. `status` shows champion health, experiment count, alerts, autonomy level in Rich table
2. `diagnose` triggers drift check and displays DriftReport
3. `rollback` swaps champion to archived version with confirmation
4. `pause` and `run` toggle agent state via JSON file
5. `journal` queries with --tag, --since, --until, --mutation, --outcome filters
6. All output uses Rich tables, panels, and colored text (CLI-06)
7. All 7 tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-sandbox-experiment-infrastructure/03-06-SUMMARY.md`
</output>
